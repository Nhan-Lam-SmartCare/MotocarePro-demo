import{t as s,m as p,n as T,v,w as C,a as R,x as O,s as m,Z as I}from"./index-DcNnBfzm.js";const _="work_orders";function D(e){return{id:e.id,creationDate:e.creationdate||e.creationDate,customerName:e.customername||e.customerName,customerPhone:e.customerphone||e.customerPhone,vehicleModel:e.vehiclemodel||e.vehicleModel,licensePlate:e.licenseplate||e.licensePlate,issueDescription:e.issuedescript||e.issueDescription,technicianName:e.technicianname||e.technicianName,status:e.status,laborCost:e.laborcost||e.laborCost||0,discount:e.discount,partsUsed:e.partsused||e.partsUsed,additionalServices:e.additionalservices||e.additionalServices,notes:e.notes,total:e.total,branchId:e.branchid||e.branchId,depositAmount:e.depositamount||e.depositAmount,depositDate:e.depositdate||e.depositDate,depositTransactionId:e.deposittransactionid||e.depositTransactionId,paymentStatus:e.paymentstatus||e.paymentStatus,paymentMethod:e.paymentmethod||e.paymentMethod,additionalPayment:e.additionalpayment||e.additionalPayment,totalPaid:e.totalpaid||e.totalPaid,remainingAmount:e.remainingamount||e.remainingAmount,paymentDate:e.paymentdate||e.paymentDate,cashTransactionId:e.cashtransactionid||e.cashTransactionId,refunded:e.refunded,refunded_at:e.refunded_at||e.refundedAt,refund_transaction_id:e.refund_transaction_id||e.refundTransactionId,refund_reason:e.refund_reason||e.refundReason}}async function q(){try{const{data:e,error:t}=await p.from(_).select("*").order("creationdate",{ascending:!1});return console.log("[fetchWorkOrders] Raw data from DB:",e),console.log("[fetchWorkOrders] Status values:",e==null?void 0:e.map(r=>({id:r.id,status:r.status}))),t?s({code:"supabase",message:"Không thể tải danh sách phiếu sửa chữa",cause:t}):v((e||[]).map(D))}catch(e){return s({code:"network",message:"Lỗi kết nối tới máy chủ",cause:e})}}async function b(e){var t;try{if(!e.id)return s({code:"validation",message:"Thiếu ID phiếu sửa chữa"});const r={p_order_id:e.id,p_customer_name:e.customerName||"",p_customer_phone:e.customerPhone||"",p_vehicle_model:e.vehicleModel||"",p_license_plate:e.licensePlate||"",p_issue_description:e.issueDescription||"",p_technician_name:e.technicianName||"",p_status:e.status||"Tiếp nhận",p_labor_cost:e.laborCost||0,p_discount:e.discount||0,p_parts_used:e.partsUsed||[],p_additional_services:e.additionalServices||null,p_total:e.total||0,p_branch_id:e.branchId||"CN1",p_payment_status:e.paymentStatus||"unpaid",p_payment_method:e.paymentMethod||null,p_deposit_amount:e.depositAmount||0,p_additional_payment:e.additionalPayment||0,p_user_id:null};console.log("[DEBUG] Creating work order with payload:",JSON.stringify(r,null,2));const{data:i,error:a}=await p.rpc("work_order_create_atomic",r);if(console.log("[DEBUG] RPC Response - data:",i,"error:",a),a&&console.error("[DEBUG] RPC Error Details:",{code:a.code,message:a.message,details:a.details,hint:a.hint,fullError:JSON.stringify(a,null,2)}),a||!i){const d=(a==null?void 0:a.details)||(a==null?void 0:a.message)||"",u=d.toUpperCase();if(u.includes("INSUFFICIENT_STOCK")){let h=[];const N=d.indexOf(":");if(N!==-1){const g=d.slice(N+1).trim();try{h=JSON.parse(g)}catch{}}const A=Array.isArray(h)?h.map(g=>`${g.partName||g.partId||"?"} (còn ${g.available}, cần ${g.requested})`).join(", "):"";return s({code:"validation",message:A?`Thiếu tồn kho: ${A}`:"Tồn kho không đủ cho một hoặc nhiều phụ tùng",cause:a})}return u.includes("PART_NOT_FOUND")?s({code:"validation",message:"Không tìm thấy phụ tùng trong kho",cause:a}):u.includes("INVALID_PART")?s({code:"validation",message:"Dữ liệu phụ tùng không hợp lệ",cause:a}):u.includes("INVALID_STATUS")?s({code:"validation",message:"Trạng thái không hợp lệ",cause:a}):u.includes("INVALID_PAYMENT_STATUS")?s({code:"validation",message:"Trạng thái thanh toán không hợp lệ",cause:a}):u.includes("UNAUTHORIZED")?s({code:"supabase",message:"Bạn không có quyền tạo phiếu sửa chữa",cause:a}):u.includes("BRANCH_MISMATCH")?s({code:"validation",message:"Chi nhánh không khớp với quyền hiện tại",cause:a}):s({code:"supabase",message:"Tạo phiếu sửa chữa (atomic) thất bại",cause:a})}const n=i.workOrder,l=i.orderId,k=i.depositTransactionId,y=i.paymentTransactionId,c=i.inventoryTxCount;if(!n&&!l)return s({code:"unknown",message:"Kết quả RPC không hợp lệ"});let o=null;if(n)o=D(n);else if(l){const{data:d,error:u}=await p.from(_).select("*").eq("id",l).single();u?console.error("[createWorkOrderAtomic] Cannot fetch order by ID",{orderId:l,fetchError:u}):d&&(o=D(d))}if(!o)return s({code:"supabase",message:"Không thể tải dữ liệu phiếu sửa chữa vừa tạo"});let f=null;try{const{data:d}=await p.auth.getUser();f=((t=d==null?void 0:d.user)==null?void 0:t.id)||null}catch{}return await T(f,{action:"work_order.create",tableName:_,recordId:o.id,oldData:null,newData:o}),v({...o,depositTransactionId:k,paymentTransactionId:y,inventoryTxCount:c})}catch(r){return s({code:"network",message:"Lỗi kết nối khi tạo phiếu sửa chữa (atomic)",cause:r})}}async function U(e){var t;try{if(!e.id)return s({code:"validation",message:"Thiếu ID phiếu sửa chữa"});const r={p_order_id:e.id,p_customer_name:e.customerName||"",p_customer_phone:e.customerPhone||"",p_vehicle_model:e.vehicleModel||"",p_license_plate:e.licensePlate||"",p_issue_description:e.issueDescription||"",p_technician_name:e.technicianName||"",p_status:e.status||"Tiếp nhận",p_labor_cost:e.laborCost||0,p_discount:e.discount||0,p_parts_used:e.partsUsed||[],p_additional_services:e.additionalServices||null,p_total:e.total||0,p_payment_status:e.paymentStatus||"unpaid",p_payment_method:e.paymentMethod||null,p_deposit_amount:e.depositAmount||0,p_additional_payment:e.additionalPayment||0,p_user_id:null},{data:i,error:a}=await p.rpc("work_order_update_atomic",r);if(a||!i){const c=(a==null?void 0:a.details)||(a==null?void 0:a.message)||"",o=c.toUpperCase();if(o.includes("INSUFFICIENT_STOCK")){let f=[];const d=c.indexOf(":");if(d!==-1){const h=c.slice(d+1).trim();try{f=JSON.parse(h)}catch{}}const u=Array.isArray(f)?f.map(h=>`${h.partName||h.partId||"?"} (còn ${h.available}, cần ${h.requested})`).join(", "):"";return s({code:"validation",message:u?`Thiếu tồn kho: ${u}`:"Tồn kho không đủ cho một hoặc nhiều phụ tùng",cause:a})}return o.includes("ORDER_NOT_FOUND")?s({code:"validation",message:"Không tìm thấy phiếu sửa chữa",cause:a}):o.includes("PART_NOT_FOUND")?s({code:"validation",message:"Không tìm thấy phụ tùng trong kho",cause:a}):o.includes("INVALID_PART")?s({code:"validation",message:"Dữ liệu phụ tùng không hợp lệ",cause:a}):o.includes("UNAUTHORIZED")?s({code:"supabase",message:"Bạn không có quyền cập nhật phiếu sửa chữa",cause:a}):o.includes("BRANCH_MISMATCH")?s({code:"validation",message:"Chi nhánh không khớp với quyền hiện tại",cause:a}):s({code:"supabase",message:"Cập nhật phiếu sửa chữa (atomic) thất bại",cause:a})}const n=i.workOrder,l=i.depositTransactionId,k=i.paymentTransactionId;if(!n)return s({code:"unknown",message:"Kết quả RPC không hợp lệ"});let y=null;try{const{data:c}=await p.auth.getUser();y=((t=c==null?void 0:c.user)==null?void 0:t.id)||null}catch{}return await T(y,{action:"work_order.update",tableName:_,recordId:n.id,oldData:null,newData:n}),v({...n,depositTransactionId:l,paymentTransactionId:k})}catch(r){return s({code:"network",message:"Lỗi kết nối khi cập nhật phiếu sửa chữa (atomic)",cause:r})}}async function S(e){var t;try{const{error:r}=await p.from(_).delete().eq("id",e);if(r)return s({code:"supabase",message:"Không thể xóa phiếu sửa chữa",cause:r});let i=null;try{const{data:a}=await p.auth.getUser();i=((t=a==null?void 0:a.user)==null?void 0:t.id)||null}catch{}return await T(i,{action:"work_order.delete",tableName:_,recordId:e,oldData:null,newData:null}),v(void 0)}catch(r){return s({code:"network",message:"Lỗi kết nối khi xóa phiếu sửa chữa",cause:r})}}async function K(e,t){var r;try{let i=null;try{const{data:c}=await p.auth.getUser();i=((r=c==null?void 0:c.user)==null?void 0:r.id)||null}catch{}const{data:a,error:n}=await p.rpc("work_order_refund_atomic",{p_order_id:e,p_refund_reason:t,p_user_id:i||"unknown"});if(n||!a){console.error("[refundWorkOrder] RPC error:",n),console.error("[refundWorkOrder] Error code:",n==null?void 0:n.code),console.error("[refundWorkOrder] Error message:",n==null?void 0:n.message),console.error("[refundWorkOrder] Error details:",n==null?void 0:n.details);const o=((n==null?void 0:n.details)||(n==null?void 0:n.message)||"").toUpperCase();return o.includes("ORDER_NOT_FOUND")?s({code:"validation",message:"Không tìm thấy phiếu sửa chữa",cause:n}):o.includes("ALREADY_REFUNDED")?s({code:"validation",message:"Phiếu này đã được hoàn tiền rồi",cause:n}):o.includes("UNAUTHORIZED")?s({code:"supabase",message:"Bạn không có quyền hoàn tiền",cause:n}):o.includes("BRANCH_MISMATCH")?s({code:"validation",message:"Chi nhánh không khớp với quyền hiện tại",cause:n}):s({code:"supabase",message:`Hoàn tiền thất bại: ${(n==null?void 0:n.message)||"Unknown error"}`,cause:n})}const l=a.workOrder,k=a.refund_transaction_id,y=a.refundAmount;return l?(await T(i,{action:"work_order.refund",tableName:_,recordId:e,oldData:null,newData:l}),v({...l,refund_transaction_id:k,refundAmount:y})):s({code:"unknown",message:"Kết quả RPC không hợp lệ"})}catch(i){return s({code:"network",message:"Lỗi kết nối khi hoàn tiền",cause:i})}}const E=()=>C({queryKey:["workOrdersRepo"],queryFn:async()=>{const e=await q();if(!e.ok)throw e.error;return e.data}}),W=()=>{const e=R();return O({mutationFn:async t=>{const r=await b(t);if(!r.ok)throw r.error;return r.data},onSuccess:t=>{e.invalidateQueries({queryKey:["workOrdersRepo"]}),e.invalidateQueries({queryKey:["partsRepo"]}),e.invalidateQueries({queryKey:["partsRepoPaged"]}),e.invalidateQueries({queryKey:["inventoryTxRepo"]}),m.success("Đã tạo phiếu sửa chữa (atomic)"),t!=null&&t.inventoryTxCount&&m.info(`Xuất kho: ${t.inventoryTxCount} phụ tùng`)},onError:t=>m.error(I(t))})},Q=()=>{const e=R();return O({mutationFn:async t=>{const r=await U(t);if(!r.ok)throw r.error;return r.data},onSuccess:()=>{e.invalidateQueries({queryKey:["workOrdersRepo"]}),e.invalidateQueries({queryKey:["partsRepo"]}),e.invalidateQueries({queryKey:["partsRepoPaged"]}),e.invalidateQueries({queryKey:["inventoryTxRepo"]}),m.success("Đã cập nhật lệnh sửa chữa")},onError:t=>m.error(I(t))})},F=()=>{const e=R();return O({mutationFn:({id:t})=>S(t),onSuccess:()=>{e.invalidateQueries({queryKey:["workOrdersRepo"]}),e.invalidateQueries({queryKey:["partsRepo"]}),e.invalidateQueries({queryKey:["partsRepoPaged"]}),e.invalidateQueries({queryKey:["inventoryTxRepo"]}),m.success("Đã hủy lệnh sửa chữa")},onError:t=>m.error(I(t))})},M=()=>{const e=R();return O({mutationFn:({orderId:t,refundReason:r})=>K(t,r),onSuccess:t=>{e.invalidateQueries({queryKey:["workOrdersRepo"]}),e.invalidateQueries({queryKey:["partsRepo"]}),e.invalidateQueries({queryKey:["partsRepoPaged"]}),e.invalidateQueries({queryKey:["inventoryTxRepo"]}),m.success("Đã hoàn tiền phiếu sửa chữa"),t.ok&&t.data.refundAmount&&m.info(`Hoàn tiền: ${new Intl.NumberFormat("vi-VN").format(t.data.refundAmount)}đ`)},onError:t=>m.error(I(t))})};export{M as a,F as b,W as c,Q as d,E as u};
